<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Competitive Monitor - Enhanced Intelligence Dashboard</title>
    <style>
        :root {
            --primary-bg: #1a1a2e;
            --secondary-bg: #2a2a3e;
            --accent-bg: #1e1e3e;
            --primary-color: #667eea;
            --accent-color: #00ff88;
            --error-color: #ff4444;
            --warning-color: #ffa726;
            --text-primary: #eee;
            --text-secondary: #bbb;
            --border-color: #3a3a5e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            border-radius: 12px;
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            color: white;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .ai-badge {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-color);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .auth-section {
            background: var(--secondary-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .tabs {
            display: flex;
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
            min-width: 120px;
        }

        .tab:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-primary {
            background: linear-gradient(135deg, var(--accent-color) 0%, #00cc6a 100%);
            color: #000;
        }

        .button-secondary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            color: white;
        }

        .button-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #ff7043 100%);
            color: white;
        }

        .button-ai {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .button:active:not(:disabled) {
            transform: translateY(0px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            transition: all 0.1s ease;
        }

        .button.clicking {
            transform: scale(0.95);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: all 0.1s ease;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .status-card {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .status-card h3 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
            font-size: 14px;
        }

        .status-card .value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .status-card .label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
        }

        .ai-features {
            background: var(--secondary-bg);
            border: 2px solid var(--accent-color);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .ai-features h3 {
            color: var(--accent-color);
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .feature-card {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .feature-card h4 {
            margin: 0 0 10px 0;
            color: var(--accent-color);
            font-size: 16px;
        }

        .feature-card p {
            margin: 0;
            font-size: 14px;
            opacity: 0.8;
        }

        .feature-status {
            float: right;
            font-size: 20px;
            margin-top: -5px;
        }

        .config-section {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h4 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            box-sizing: border-box;
        }

        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--accent-bg);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--primary-bg);
            color: var(--primary-color);
            font-weight: 600;
        }

        .data-table tr:hover {
            background: var(--secondary-bg);
        }

        .log-container {
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-timestamp {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .log-level-info { color: #4a9eff; }
        .log-level-success { color: var(--accent-color); }
        .log-level-warning { color: var(--warning-color); }
        .log-level-error { color: var(--error-color); }

        .error-message, .success-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: var(--error-color);
        }

        .success-message {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .company-card {
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .company-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .company-card h3 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
        }

        .company-card .url {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 14px;
            word-break: break-all;
        }

        .company-card .status {
            margin: 10px 0;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
        }

        .status-operational {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-color);
        }

        .status-error {
            background: rgba(255, 68, 68, 0.2);
            color: var(--error-color);
        }

        .status-checking {
            background: rgba(255, 167, 38, 0.2);
            color: var(--warning-color);
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="ai-badge">🤖 AI-Enhanced v84 🚀 ALL SCRIPTS RESTORED + THEBRAIN READY</div>
            <h1>AI Competitor Monitor</h1>
            <p>Advanced Intelligence & Real-time Competitive Analysis with Enhanced Error Visibility</p>
        </div>

        <!-- Authentication -->
        <div class="auth-section" id="authSection">
            <h3>🔐 Authentication</h3>
            <p>Enter your API token to access the enhanced AI monitoring system:</p>
            <div class="input-group">
                <input type="password" id="apiToken" placeholder="Enter API token" value="dev-token-change-me">
                <button onclick="saveToken(event)" class="button button-primary" style="margin-top: 10px;" type="button">💾 Save Token</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs" id="tabsSection" style="display: none;">
            <button class="tab active" onclick="showTab(event, 'dashboard')">📊 Dashboard</button>
            <button class="tab" onclick="showTab(event, 'extracted')">📄 Extracted Data</button>
            <button class="tab" onclick="showTab(event, 'changes')">📈 Change History</button>
            <button class="tab" onclick="showTab(event, 'configuration')">⚙️ Configuration</button>
            <button class="tab" onclick="showTab(event, 'baseline')">🚀 Baseline</button>
            <button class="tab" onclick="showTab(event, 'logs')">📝 System Logs</button>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" id="actionButtonsSection" style="display: none;">
            <button class="button button-primary" onclick="refreshStatus(event)">🔄 Refresh Status</button>
            <button class="button button-secondary" onclick="checkForUpdates(event)">🔍 Check for Updates</button>
            <button class="button button-warning" onclick="runMonitorCheck(event)">🔍 Run Monitor Check</button>
            <button class="button button-ai" onclick="openTheBrain(event)">🧠 TheBrain Integration</button>
        </div>

        <!-- System Status -->
        <div class="status-grid" id="statusGrid" style="display: none;">
            <div class="status-card">
                <h3>System Status</h3>
                <div class="value" id="systemStatus">Loading...</div>
                <div class="label">STATUS</div>
            </div>
            <div class="status-card">
                <h3>Companies Monitored</h3>
                <div class="value" id="companiesCount">--</div>
                <div class="label">COMPANIES</div>
            </div>
            <div class="status-card">
                <h3>URLs Tracked</h3>
                <div class="value" id="urlsCount">--</div>
                <div class="label">URLS TRACKED</div>
            </div>
            <div class="status-card">
                <h3>Last Check</h3>
                <div class="value" id="lastCheck">--</div>
                <div class="label">LAST CHECK</div>
            </div>
            <div class="status-card">
                <h3>AI Features</h3>
                <div class="value" id="aiStatus">⚙️</div>
                <div class="label">AI STATUS</div>
            </div>
            <div class="status-card">
                <h3>CORS Status</h3>
                <div class="value">✅</div>
                <div class="label">CORS FIXED</div>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="contentArea" style="display: none;">
            <div id="dashboardTab" class="tab-content" style="display: block;">
                <h2>🎯 AI Intelligence Dashboard</h2>
                
                <!-- AI Intelligence Features -->
                <div class="ai-features">
                    <h3>🤖 Advanced AI Intelligence Features (Active)</h3>
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h4>🎯 Change Magnitude Detection <span class="feature-status">✅</span></h4>
                            <p>AI precisely calculates how much each page changed (5%, 25%, 50%+) using advanced content diffing algorithms</p>
                        </div>
                        <div class="feature-card">
                            <h4>🧠 Claude Relevance Scoring (1-10) <span class="feature-status">✅</span></h4>
                            <p>Claude AI evaluates the business importance and competitive significance of each detected change</p>
                        </div>
                        <div class="feature-card">
                            <h4>🎨 Smart Content Extraction <span class="feature-status">✅</span></h4>
                            <p>Intelligent CSS selectors and content parsing focused on strategic business content areas</p>
                        </div>
                        <div class="feature-card">
                            <h4>📊 Competitive Intelligence <span class="feature-status">✅</span></h4>
                            <p>Automated detection of competitor mentions, feature launches, pricing changes, and strategic shifts</p>
                        </div>
                        <div class="feature-card">
                            <h4>⚙️ Configurable Thresholds <span class="feature-status">✅</span></h4>
                            <p>Custom sensitivity settings per company, page type, and content category for precise monitoring</p>
                        </div>
                        <div class="feature-card">
                            <h4>🧠 TheBrain Integration <span class="feature-status">🔗</span></h4>
                            <p>Automatic knowledge mapping and relationship visualization of competitive intelligence</p>
                        </div>
                    </div>
                </div>
                
                <div id="companiesDisplay">
                    <h3>📊 Monitored Companies</h3>
                    <div class="loading">Click "Refresh Status" to load company data</div>
                </div>
            </div>

            <div id="extractedTab" class="tab-content">
                <h2>📄 AI-Enhanced Extracted Data Analysis</h2>
                
                <!-- Filter Controls -->
                <div class="config-section">
                    <h4>🔍 Filter Options</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div class="input-group">
                            <label for="companyFilter">Company:</label>
                            <select id="companyFilter">
                                <option value="">All Companies</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="typeFilter">Content Type:</label>
                            <select id="typeFilter">
                                <option value="">All Types</option>
                                <option value="pricing">Pricing</option>
                                <option value="blog">Blog</option>
                                <option value="product">Product</option>
                                <option value="docs">Documentation</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="keywordFilter">Keyword Search:</label>
                            <input type="text" id="keywordFilter" placeholder="Enter keyword...">
                        </div>
                    </div>
                    <div class="action-buttons" style="margin: 0;">
                        <button class="button button-primary" onclick="loadExtractedData(event)">🔄 Apply Filters & Load Data</button>
                        <button class="button button-secondary" onclick="clearFilters(event)">🗑️ Clear Filters</button>
                    </div>
                </div>
                
                <div id="extractedDataContent">
                    <div class="error-message">Select filters and click "Apply Filters & Load Data" to view AI-enhanced content analysis...</div>
                </div>
            </div>

            <div id="changesTab" class="tab-content">
                <h2>📈 AI-Filtered Change History & Analysis</h2>
                <button class="button button-secondary" onclick="loadChangeHistory(event)">🔄 Load Change History</button>
                <div id="changeHistoryContent">
                    <div class="error-message">Click "Load Change History" to view AI-filtered changes...</div>
                </div>
            </div>

            <div id="configurationTab" class="tab-content">
                <h2>⚙️ System Configuration</h2>
                
                <!-- Company Management -->
                <div class="config-section">
                    <h4>🏢 Company Management</h4>
                    <div class="action-buttons" style="margin: 15px 0;">
                        <button class="button button-primary" onclick="showAddCompanyForm(event)">➕ Add Company</button>
                        <button class="button button-secondary" onclick="loadCompanyList(event)">🔄 Refresh List</button>
                    </div>
                    
                    <div id="addCompanyForm" style="display: none; background: var(--accent-bg); padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <h5>Add New Company</h5>
                        <div class="input-group">
                            <label for="newCompanyName">Company Name:</label>
                            <input type="text" id="newCompanyName" placeholder="Enter company name">
                        </div>
                        <div class="input-group">
                            <label for="newCompanyUrls">URLs (one per line):</label>
                            <textarea id="newCompanyUrls" rows="5" placeholder="https://example.com/pricing\nhttps://example.com/blog\nhttps://example.com/docs"></textarea>
                        </div>
                        <div class="input-group">
                            <label for="newCompanyType">Primary Type:</label>
                            <select id="newCompanyType">
                                <option value="competitor">Competitor</option>
                                <option value="partner">Partner</option>
                                <option value="vendor">Vendor</option>
                                <option value="customer">Customer</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="action-buttons" style="margin: 15px 0;">
                            <button class="button button-primary" onclick="addCompany(event)">✅ Add Company</button>
                            <button class="button button-secondary" onclick="hideAddCompanyForm(event)">❌ Cancel</button>
                        </div>
                    </div>
                    
                    <div id="companyListContainer">
                        <div class="loading">Click "Refresh List" to load companies...</div>
                    </div>
                </div>
                
                <!-- Monitoring Parameters -->
                <div class="config-section">
                    <h4>🎛️ Monitoring Parameters</h4>
                    <div class="input-group">
                        <label for="checkFrequency">Check Frequency:</label>
                        <select id="checkFrequency">
                            <option value="hourly">Every Hour</option>
                            <option value="daily" selected>Daily</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="changeThreshold">Change Detection Threshold (%):</label>
                        <input type="number" id="changeThreshold" value="5" min="1" max="100">
                    </div>
                    <div class="input-group">
                        <label for="relevanceThreshold">Minimum Relevance Score:</label>
                        <input type="number" id="relevanceThreshold" value="7" min="1" max="10">
                    </div>
                    <button class="button button-primary" onclick="saveMonitoringParameters(event)" style="margin-top: 15px;">💾 Save Parameters</button>
                </div>
                
                <!-- System Info -->
                <div class="config-section">
                    <h4>📊 System Information</h4>
                    <button class="button button-secondary" onclick="loadSystemConfig(event)">🔄 Load System Config</button>
                    <div id="systemConfigContent">
                        <div class="error-message">Click "Load System Config" to view current settings...</div>
                    </div>
                </div>
            </div>

            <div id="baselineTab" class="tab-content">
                <h2>🚀 AI-Enhanced Baseline Management</h2>
                <p>Generate and manage AI-enhanced baseline snapshots with intelligent content extraction and markdown export.</p>
                
                <!-- Baseline Options -->
                <div class="config-section">
                    <h4>🎯 Baseline Generation Options</h4>
                    <div class="action-buttons" style="margin: 15px 0;">
                        <button class="button button-primary" onclick="generateBaseline(event, { mode: 'all', clearExisting: true })" title="Delete all existing data and create fresh baseline">🔄 Baseline All (Fresh Start)</button>
                        <button class="button button-secondary" onclick="generateBaseline(event, { mode: 'new', clearExisting: false })" title="Only process URLs not already in baseline">➕ Baseline New URLs Only</button>
                        <button class="button button-warning" onclick="checkBaselineStatus(event)" title="Check current baseline status">📊 Check Status</button>
                    </div>
                    <p style="font-size: 14px; color: var(--text-secondary); margin: 10px 0;">
                        <strong>Tip:</strong> "Baseline All" will delete existing data and rebuild everything. "Baseline New" only processes URLs not already captured.
                    </p>
                </div>
                
                <div id="baselineContent">
                    <div class="error-message">Select a baseline option above to begin AI-enhanced content extraction with progress tracking and error handling...</div>
                </div>
            </div>

            <div id="logsTab" class="tab-content">
                <h2>📝 AI System Logs & Monitoring</h2>
                <button class="button button-secondary" onclick="loadSystemLogs(event)">🔄 Refresh Logs</button>
                <div id="systemLogsContent">
                    <div class="error-message">Click "Refresh Logs" to load AI system logs...</div>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorDisplay" style="display: none;" class="error-message"></div>
    </div>

    <script>
        // v79: FIXED INFINITE LOOPS + PROPER EVENT HANDLING
        const CONFIG = {
            apiUrl: 'https://script.google.com/macros/s/AKfycbxMnn18-mPJnjV2cR9ZWjWJJKJJ-RtuW_NWv3eJ5N08RNEpMz9SYM4_bYP5f88snoV_6w/exec',
            token: 'dev-token-change-me',
            version: 84,
            aiEnhanced: true,
            corsFixed: true
        };

        // Global state
        let authenticated = false;
        let currentTab = 'dashboard';
        let isLoading = false;
        let isStatusLoading = false; // Prevent recursive status calls
        let systemStatus = {};
        let companies = [];

        // Initialize the application
        function init() {
            console.log('🚀 AI Competitive Monitor v81 - Batch Processing + AI Intelligence');
            console.log('✅ CORS Fixed - Using proven deployment URL:', CONFIG.apiUrl);
            console.log('🤖 AI Features: Relevance scoring, keyword extraction, competitor detection');
            console.log('🚀 New: Batch processing for all 55 URLs with progress tracking');
            console.log('📊 Progress: Real-time updates during baseline generation');
            
            // Load saved token - FIXED: Prevent corruption on reload
            const savedToken = localStorage.getItem('apiToken');
            if (savedToken && savedToken !== 'dev-token-change-me' && savedToken.trim() !== '') {
                // Only use the saved token if it's clean (not duplicated)
                const cleanToken = savedToken.trim();
                if (!cleanToken.includes('dev-token-change-medev-token-change-me')) {
                    document.getElementById('apiToken').value = cleanToken;
                    CONFIG.token = cleanToken;
                    authenticated = true;
                    showMainInterface();
                    console.log('✅ Loaded clean saved token:', cleanToken.substring(0, 10) + '...');
                    // Use a timeout to prevent any initialization race conditions
                    setTimeout(() => {
                        if (!isStatusLoading) {
                            refreshStatus();
                        }
                    }, 1000);
                } else {
                    // Token is corrupted, clear it
                    console.log('⚠️ Corrupted token detected, clearing...');
                    localStorage.removeItem('apiToken');
                    document.getElementById('apiToken').value = 'dev-token-change-me';
                }
            }
        }

        // API Helper with improved error handling
        async function apiCall(action, params = {}) {
            // Prevent multiple simultaneous status calls
            if (action === 'status' && isStatusLoading) {
                console.log('⚠️ Status check already in progress, skipping...');
                return { error: 'Status check already in progress' };
            }

            try {
                if (action === 'status') {
                    isStatusLoading = true;
                }
                isLoading = true;
                
                const urlParams = new URLSearchParams({
                    action: action,
                    token: CONFIG.token,
                    ...params
                });
                
                console.log(`🤖 AI API Call: ${action} - v80 with extracted data fix`);
                
                const response = await fetch(`${CONFIG.apiUrl}?${urlParams}`, {
                    method: 'GET',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Log AI enhancements
                if (data.aiEnhanced) {
                    console.log('✅ AI-Enhanced Response Received');
                }
                if (data.corsFixed) {
                    console.log('✅ CORS Fixed Response Confirmed');
                }
                
                return data;
            } catch (error) {
                console.error('❌ AI API call failed:', error);
                showError(`API Error: ${error.message}`);
                return { error: error.message };
            } finally {
                isLoading = false;
                if (action === 'status') {
                    isStatusLoading = false;
                }
            }
        }

        // Token Management - FIXED: Prevent token duplication
        function saveToken(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            const token = document.getElementById('apiToken').value.trim();
            if (!token || token === '') {
                showError('Please enter a valid token');
                return;
            }
            
            // Clear any existing token to prevent duplication
            localStorage.removeItem('apiToken');
            
            // Save the clean token
            CONFIG.token = token;
            localStorage.setItem('apiToken', token);
            authenticated = true;
            showMainInterface();
            showSuccess('💾 API token saved successfully! AI features ready.');
            
            console.log('✅ Token saved:', token.substring(0, 10) + '...');
            
            // Refresh status after authentication with delay to prevent issues
            setTimeout(() => {
                if (authenticated && !isStatusLoading) {
                    refreshStatus();
                }
            }, 1500);
        }

        // UI Management
        function showMainInterface() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('tabsSection').style.display = 'flex';
            document.getElementById('actionButtonsSection').style.display = 'flex';
            document.getElementById('statusGrid').style.display = 'grid';
            document.getElementById('contentArea').style.display = 'block';
        }

        function showTab(event, tabName) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Update tab buttons
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Update tab content
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.style.display = 'none');
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            currentTab = tabName;
            
            // Check for existing baseline job when extracted tab is shown
            if (tabName === 'extracted') {
                checkBaselineStatus();
            }
        }
        
        // Check baseline completion status
        async function checkBaselineStatus() {
            try {
                const completed = await apiCall('baseline-completed');
                if (completed.completed) {
                    // Show baseline completed status
                    const extractedTab = document.getElementById('extractedTab');
                    const statusBanner = document.createElement('div');
                    statusBanner.className = 'success-message';
                    statusBanner.style.marginBottom = '20px';
                    statusBanner.innerHTML = `
                        ✅ Baseline completed on ${new Date(completed.timestamp).toLocaleString()}<br>
                        ${completed.rowCount} URLs successfully extracted and stored.<br>
                        <small>To regenerate baseline, use "Fetch Data" > "Baseline All"</small>
                    `;
                    
                    // Insert at the top of the tab
                    const existingBanner = extractedTab.querySelector('.baseline-status-banner');
                    if (existingBanner) {
                        existingBanner.remove();
                    }
                    statusBanner.className = 'success-message baseline-status-banner';
                    extractedTab.insertBefore(statusBanner, extractedTab.firstChild.nextSibling);
                }
            } catch (error) {
                console.error('Error checking baseline status:', error);
            }
        }
        
        // Check for existing baseline job
        async function checkExistingBaselineJob() {
            try {
                const status = await apiCall('baseline-status');
                
                if (status.active) {
                    // There's an active job, start polling
                    if (!baselinePollingInterval) {
                        baselinePollingInterval = setInterval(pollBaselineProgress, 2000);
                    }
                    // Show current progress immediately
                    pollBaselineProgress();
                }
            } catch (error) {
                console.error('Error checking baseline job:', error);
            }
        }

        // Status Management - FIXED: Prevent infinite loop
        async function refreshStatus(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            if (isStatusLoading) {
                console.log('⚠️ Status refresh already in progress');
                return;
            }
            
            console.log('🔄 Refreshing AI-enhanced status (v80 - extracted data fixed)...');
            const statusData = await apiCall('status');
            
            if (statusData.error) {
                showError(`Status Error: ${statusData.error}`);
                return;
            }
            
            systemStatus = statusData;
            updateStatusDisplay(statusData);
            
            // Load companies if not already loaded
            if (companies.length === 0) {
                loadCompanies();
            }
        }

        function updateStatusDisplay(status) {
            document.getElementById('systemStatus').textContent = status.status || 'checking...';
            document.getElementById('companiesCount').textContent = status.companiesMonitored || '--';
            document.getElementById('urlsCount').textContent = status.urlsTracked || '--';
            document.getElementById('lastCheck').textContent = formatTimeAgo(status.lastCheck) || '--';
            document.getElementById('aiStatus').textContent = status.aiEnabled ? '✅' : '⚙️';
        }

        async function loadCompanies() {
            const data = await apiCall('config');
            if (data.error) {
                showError(`Companies Error: ${data.error}`);
                return;
            }
            
            companies = data.companies || data.monitors || [];
            console.log(`📊 Loaded ${companies.length} companies with AI monitoring`);
            updateCompaniesDisplay();
            updateCompanyFilter();
        }
        
        function updateCompanyFilter() {
            const companyFilter = document.getElementById('companyFilter');
            if (!companyFilter) return;
            
            // Clear existing options except "All Companies"
            companyFilter.innerHTML = '<option value="">All Companies</option>';
            
            // Add company options
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.company;
                option.textContent = company.company;
                companyFilter.appendChild(option);
            });
        }

        function updateCompaniesDisplay() {
            const companiesDisplay = document.getElementById('companiesDisplay');
            if (companies.length === 0) {
                companiesDisplay.innerHTML = '<div class="error-message">No company data available. Click "Refresh Status" to load data.</div>';
                return;
            }
            
            let html = '<h3>📊 Monitored Companies</h3><div class="companies-grid">';
            companies.forEach(company => {
                const urls = company.urls || [];
                html += `
                    <div class="company-card">
                        <h3>${company.company}</h3>
                        <div class="status status-operational">AI-Enhanced Monitoring</div>
                        <p><strong>URLs:</strong> ${urls.length}</p>
                        <div style="margin-top: 10px;">
                `;
                
                urls.slice(0, 2).forEach(url => {
                    html += `<div><a href="${url}" target="_blank" class="url">${url}</a></div>`;
                });
                
                if (urls.length > 2) {
                    html += `<div style="color: #999; font-size: 12px;">+${urls.length - 2} more URLs</div>`;
                }
                
                html += '</div></div>';
            });
            html += '</div>';
            companiesDisplay.innerHTML = html;
        }

        // Enhanced button click feedback
        function addClickFeedback(buttonElement) {
            if (!buttonElement) return;
            buttonElement.classList.add('clicking');
            setTimeout(() => {
                buttonElement.classList.remove('clicking');
            }, 150);
        }

        // Progress polling for baseline generation
        let baselinePollingInterval = null;
        
        async function pollBaselineProgress() {
            try {
                const status = await apiCall('baseline-status');
                
                if (status.error) {
                    console.error('Error getting baseline status:', status.error);
                    return;
                }
                
                if (status.active) {
                    // Update progress display
                    const progress = status.progress;
                    let errorDetails = '';
                    if (status.recentErrors && status.recentErrors.length > 0) {
                        errorDetails = '<div style="margin-top: 10px; padding: 10px; background: rgba(255, 68, 68, 0.1); border-radius: 5px;">';
                        errorDetails += '<strong>Recent Errors:</strong><br>';
                        status.recentErrors.forEach(err => {
                            errorDetails += `<small>${err.company} - ${err.url}: ${err.error}</small><br>`;
                        });
                        errorDetails += '</div>';
                    }
                    
                    const progressHtml = `
                        <div class="success-message">
                            🤖 AI-enhanced baseline generation in progress!<br>
                            <div style="margin: 15px 0;">
                                <div style="background: var(--secondary-bg); border-radius: 8px; height: 30px; overflow: hidden; position: relative;">
                                    <div style="background: linear-gradient(90deg, var(--accent-color), var(--primary-color)); height: 100%; width: ${progress.percent}%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center;">
                                        <span style="color: white; font-weight: bold; position: absolute; left: 50%; transform: translateX(-50%);">${progress.percent}%</span>
                                    </div>
                                </div>
                            </div>
                            Progress: ${progress.completed}/${progress.total} URLs processed<br>
                            ${status.successful ? `Successful: ${status.successful}<br>` : ''}
                            ${progress.failed > 0 ? `<span style="color: var(--error-color);">Errors: ${progress.failed}</span><br>` : ''}
                            Estimated time remaining: ${progress.estimated_time_remaining}<br>
                            ${errorDetails}
                            <br>
                            <em>The system will continue processing in the background. You can safely navigate away.</em>
                        </div>
                    `;
                    document.getElementById('baselineContent').innerHTML = progressHtml;
                } else if (status.status === 'paused_error') {
                    // Job paused due to errors
                    const progressHtml = `
                        <div class="error-message">
                            ⚠️ Baseline generation paused due to errors!<br><br>
                            Progress: ${status.processed}/${status.total} URLs<br>
                            Successful: ${status.successful}<br>
                            Failed: ${status.failed}<br>
                            Last error: ${status.lastError}<br><br>
                            <button class="button button-primary" onclick="resumeBaselineGeneration(event)">🔄 Resume</button>
                            <button class="button button-warning" onclick="cancelBaselineGeneration(event)">❌ Cancel</button>
                        </div>
                    `;
                    document.getElementById('baselineContent').innerHTML = progressHtml;
                    
                    // Stop polling
                    if (baselinePollingInterval) {
                        clearInterval(baselinePollingInterval);
                        baselinePollingInterval = null;
                    }
                } else {
                    // No active job, stop polling
                    if (baselinePollingInterval) {
                        clearInterval(baselinePollingInterval);
                        baselinePollingInterval = null;
                    }
                }
                
            } catch (error) {
                console.error('Error polling baseline progress:', error);
            }
        }
        
        // Check baseline status
        async function checkBaselineStatus(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            try {
                const completed = await apiCall('baseline-completed');
                const status = await apiCall('baseline-status');
                
                let statusHtml = '<div class="success-message">';
                
                if (completed.completed) {
                    statusHtml += `
                        ✅ <strong>Baseline Completed</strong><br>
                        Generated: ${new Date(completed.timestamp).toLocaleString()}<br>
                        URLs Processed: ${completed.rowCount}<br>
                        Status: Ready for monitoring and markdown export<br><br>
                        <small>To regenerate baseline, use "Baseline All" option above.</small>
                    `;
                } else if (status.active) {
                    statusHtml += `
                        🔄 <strong>Baseline Generation In Progress</strong><br>
                        Progress: ${status.progress.completed}/${status.progress.total} URLs<br>
                        Percentage: ${status.progress.percent}%<br>
                        Estimated time remaining: ${status.progress.estimated_time_remaining}<br>
                    `;
                } else {
                    statusHtml += `
                        ⚠️ <strong>No Baseline Found</strong><br>
                        No baseline has been generated yet.<br>
                        Use "Baseline All" to create your first baseline.<br>
                    `;
                }
                
                statusHtml += '</div>';
                document.getElementById('baselineContent').innerHTML = statusHtml;
                
            } catch (error) {
                document.getElementById('baselineContent').innerHTML = `
                    <div class="error-message">❌ Error checking baseline status: ${error.message}</div>
                `;
            }
        }
        
        // Check for content updates
        async function checkForUpdates(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            showTab(null, 'changes');
            document.getElementById('changeHistoryContent').innerHTML = '<div class="loading">🔍 Checking for content updates...</div>';
            
            try {
                const result = await apiCall('check-updates');
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                let html = `<div class="success-message">✅ Update check completed!</div>`;
                
                if (result.changes && result.changes.length > 0) {
                    html += `
                        <h3>📊 ${result.changes.length} Changes Detected</h3>
                        <div class="data-table-container" style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>URL</th>
                                        <th>Change Type</th>
                                        <th>Magnitude</th>
                                        <th>AI Relevance</th>
                                        <th>Summary</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    result.changes.forEach(change => {
                        html += `
                            <tr>
                                <td>${change.company}</td>
                                <td><a href="${change.url}" target="_blank">${change.url.substring(0, 40)}...</a></td>
                                <td><span class="status status-operational">${change.type}</span></td>
                                <td>${change.magnitude}%</td>
                                <td>${change.relevanceScore}/10</td>
                                <td>${change.summary}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                } else {
                    html += '<div class="success-message">No significant changes detected since last check.</div>';
                }
                
                document.getElementById('changeHistoryContent').innerHTML = html;
                
            } catch (error) {
                document.getElementById('changeHistoryContent').innerHTML = `
                    <div class="error-message">❌ Error checking for updates: ${error.message}</div>
                `;
            }
        }
        
        // Enhanced baseline generation with options
        async function generateBaseline(event, options = {}) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            const mode = options.mode || 'all';
            const clearExisting = options.clearExisting !== false;
            
            // Show confirmation for destructive operations
            if (mode === 'all' && clearExisting) {
                if (!confirm('⚠️ This will DELETE all existing baseline data and create a fresh baseline. Are you sure?')) {
                    return;
                }
            }
            
            console.log(`🚀 Starting baseline generation - Mode: ${mode}, Clear: ${clearExisting}`);
            
            // Navigate to baseline tab
            showTab(null, 'baseline');
            document.getElementById('baselineContent').innerHTML = '<div class="loading">🤖 Starting AI-enhanced baseline generation...</div>';
            
            try {
                // For baseline-new mode, check if we already have data
                if (mode === 'new') {
                    console.log('📊 Checking for existing baseline data...');
                    const existingData = await apiCall('extracted', { limit: 5 });
                    
                    if (existingData.extractedData && existingData.extractedData.length > 0) {
                        console.log('✅ Found existing baseline data, will only process new URLs');
                    }
                }
                
                console.log(`📝 Starting baseline generation with mode: ${mode}`);
                const result = await apiCall('baseline', { 
                    mode: mode,
                    clearExisting: clearExisting 
                });
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                console.log('📊 Baseline result:', result);
                
                if (result.status === 'in_progress') {
                    // Start polling for progress
                    if (!baselinePollingInterval) {
                        baselinePollingInterval = setInterval(pollBaselineProgress, 2000); // Poll every 2 seconds
                    }
                    
                    // Show initial progress
                    document.getElementById('baselineContent').innerHTML = `
                        <div class="success-message">
                            🤖 AI-enhanced baseline generation started!<br>
                            <div style="margin: 15px 0;">
                                <div style="background: var(--secondary-bg); border-radius: 8px; height: 30px; overflow: hidden; position: relative;">
                                    <div style="background: linear-gradient(90deg, var(--accent-color), var(--primary-color)); height: 100%; width: ${result.percentComplete || 0}%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center;">
                                        <span style="color: white; font-weight: bold; position: absolute; left: 50%; transform: translateX(-50%);">${result.percentComplete || 0}%</span>
                                    </div>
                                </div>
                            </div>
                            Progress: ${result.processed || 0}/${result.total || 0} URLs<br>
                            ${result.percentComplete ? `(${result.percentComplete}% complete)` : ''}<br><br>
                            <em>The system will continue processing in the background. You can safely navigate away.</em>
                        </div>
                    `;
                } else if (result.status === 'completed') {
                    // Stop polling
                    if (baselinePollingInterval) {
                        clearInterval(baselinePollingInterval);
                        baselinePollingInterval = null;
                    }
                    
                    document.getElementById('baselineContent').innerHTML = `
                        <div class="success-message">
                            ✅ AI-enhanced baseline generation completed!<br>
                            ${result.message}<br><br>
                            🤖 AI Features: Enhanced with intelligent content extraction<br>
                            ✅ CORS Status: Fixed and operational<br>
                            📊 Baseline Status: Complete and persistent<br><br>
                            <strong>Your baseline is now saved and will persist between sessions.</strong>
                        </div>
                    `;
                    
                    // Refresh status and try to load extracted data
                    setTimeout(() => {
                        refreshStatus();
                        console.log('🔄 Baseline complete, data should now be available');
                    }, 1000);
                } else {
                    document.getElementById('baselineContent').innerHTML = `
                        <div class="success-message">
                            ✅ AI-enhanced baseline system is ready!<br>
                            ${result.message}<br><br>
                            🤖 AI Features: ${result.aiEnhanced ? 'Enhanced with intelligent content extraction' : 'Basic'}<br>
                            ✅ CORS Status: Fixed and operational<br>
                            📊 System Status: Ready for baseline generation
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('❌ Baseline generation error:', error);
                document.getElementById('baselineContent').innerHTML = `
                    <div class="error-message">
                        ❌ Error with AI-enhanced baseline: ${error.message}<br><br>
                        This might be a temporary issue. Please try again.<br>
                        If the problem persists, the backend might need debugging.
                    </div>
                `;
            }
        }

        async function runMonitorCheck(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            showSuccess('🤖 Running AI-enhanced monitor check...');
            
            try {
                const result = await apiCall('monitor');
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                const aiStatus = result.aiEnhanced ? ' with AI intelligence' : '';
                showSuccess(`✅ AI monitor check completed${aiStatus}! ${result.message || 'Check finished successfully.'}`);
                setTimeout(() => refreshStatus(), 1000);
            } catch (error) {
                showError(`❌ Error running AI monitor check: ${error.message}`);
            }
        }

        // FIXED: Prevent infinite loop in loadExtractedData
        let isExtractedDataLoading = false; // Separate flag for this function
        
        async function loadExtractedData(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            // Prevent concurrent calls with dedicated flag
            if (isExtractedDataLoading) {
                console.log('⚠️ Already loading extracted data, skipping...');
                return;
            }
            
            isExtractedDataLoading = true; // Set flag immediately
            
            // Get filter values
            const company = document.getElementById('companyFilter').value;
            const type = document.getElementById('typeFilter').value;
            const keyword = document.getElementById('keywordFilter').value;
            
            const filters = {};
            if (company) filters.company = company;
            if (type) filters.type = type;
            if (keyword) filters.keyword = keyword;
            filters.limit = 100; // Get more results for filtering
            
            console.log('📊 Loading extracted data with filters:', filters);
            document.getElementById('extractedDataContent').innerHTML = '<div class="loading">🤖 Loading AI-enhanced extracted data with filters...</div>';
            
            try {
                const data = await apiCall('extracted', filters);
                console.log('📊 Extracted data response:', data);
                
                if (data.error) {
                    console.log('❌ API returned error:', data.error);
                    document.getElementById('extractedDataContent').innerHTML = '<div class="error-message">No AI-enhanced extracted data available yet. Generate baseline first to enable AI content extraction.</div>';
                    return;
                }
                
                if (!data.extractedData || data.extractedData.length === 0) {
                    console.log('📊 No extracted data found. Suggestions:', {
                        filtersApplied: Object.keys(filters).length > 1,
                        shouldGenerateBaseline: true
                    });
                    
                    document.getElementById('extractedDataContent').innerHTML = `
                        <div class="error-message">
                            No extracted data found with current filters.<br>
                            ${Object.keys(filters).length > 1 ? 'Try removing some filters or ' : ''}
                            Generate baseline first to enable AI content extraction.<br><br>
                            <strong>Tip:</strong> The baseline only needs to be generated once and will persist between sessions.
                        </div>
                    `;
                    return;
                }
                
                console.log('✅ Successfully loaded', data.extractedData.length, 'extracted data items');
                displayExtractedData(data);
                
            } catch (error) {
                console.error('❌ Error loading extracted data:', error);
                document.getElementById('extractedDataContent').innerHTML = `<div class="error-message">❌ Error loading AI-enhanced extracted data: ${error.message}</div>`;
            } finally {
                // Always clear the flag
                isExtractedDataLoading = false;
            }
        }
        
        function displayExtractedData(data) {
            const extractedData = data.extractedData || [];
            const totalUnfiltered = data.totalUnfiltered || extractedData.length;
            
            let html = `
                <div class="success-message">
                    🤖 AI-Enhanced Extracted Data<br>
                    Found ${extractedData.length} items
                    ${totalUnfiltered > extractedData.length ? ` (filtered from ${totalUnfiltered} total)` : ''}
                </div>
            `;
            
            if (extractedData.length > 0) {
                html += '<div class="data-table-container" style="overflow-x: auto; margin: 20px 0;">';
                html += '<table class="data-table">';
                html += `
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Company</th>
                            <th>Type</th>
                            <th>URL</th>
                            <th>Content Preview</th>
                            <th>Source</th>
                            <th>AI Analysis</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                extractedData.forEach(item => {
                    const contentPreview = (item.extractedContent || item.summary || 'No content')
                        .substring(0, 100) + (item.extractedContent && item.extractedContent.length > 100 ? '...' : '');
                    
                    const aiAnalysis = item.aiProcessed ? 
                        `Relevance: ${item.relevanceScore || 0}/10, Keywords: ${item.keywords || 'None detected'}` :
                        `Relevance: ${item.relevanceScore || 0}/10`;
                    
                    const urlShort = item.url ? 
                        (item.url.length > 40 ? item.url.substring(0, 40) + '...' : item.url) : 'N/A';
                    
                    html += `
                        <tr>
                            <td>${new Date(item.timestamp).toLocaleDateString()}</td>
                            <td><strong>${item.company || 'Unknown'}</strong></td>
                            <td><span class="status status-operational">${item.type || item.urlType || 'General'}</span></td>
                            <td><a href="${item.url}" target="_blank" class="url" title="${item.url}">${urlShort}</a></td>
                            <td style="max-width: 200px;">${contentPreview}</td>
                            <td>${item.source || 'Unknown'}</td>
                            <td style="font-size: 12px;">${aiAnalysis}</td>
                            <td>
                                <button class="button button-secondary" style="padding: 5px 10px; font-size: 12px;" 
                                        onclick="viewFullContent('${encodeURIComponent(item.url)}', 'json')" title="View full content">
                                    📄 View
                                </button>
                                <button class="button button-secondary" style="padding: 5px 10px; font-size: 12px; margin-left: 5px;" 
                                        onclick="viewFullContent('${encodeURIComponent(item.url)}', 'markdown')" title="Export as Markdown">
                                    📝 MD
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
            }
            
            document.getElementById('extractedDataContent').innerHTML = html;
        }
        
        function clearFilters(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            document.getElementById('companyFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('keywordFilter').value = '';
            
            // Optional: Auto-reload with cleared filters
            document.getElementById('extractedDataContent').innerHTML = '<div class="error-message">Filters cleared. Click "Apply Filters & Load Data" to view all extracted data...</div>';
        }
        
        // View full content in a modal or new window
        async function viewFullContent(encodedUrl, format) {
            const url = decodeURIComponent(encodedUrl);
            
            try {
                const result = await apiCall('baseline-content', { url: url, format: format });
                
                if (result.success && result.data) {
                    if (format === 'markdown') {
                        // Create a downloadable markdown file
                        const blob = new Blob([result.data], { type: 'text/markdown' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `${result.data.company || 'content'}_${new Date().toISOString().split('T')[0]}.md`;
                        link.click();
                        showSuccess('📥 Markdown file downloaded!');
                    } else {
                        // Show in a modal
                        showContentModal(result.data);
                    }
                } else {
                    showError('Failed to load content: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Error loading content: ' + error.message);
            }
        }
        
        // Show content in a modal
        function showContentModal(content) {
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: var(--secondary-bg);
                border-radius: 12px;
                padding: 30px;
                max-width: 80%;
                max-height: 80%;
                overflow-y: auto;
                position: relative;
            `;
            
            modalContent.innerHTML = `
                <h2>${content.title || content.url}</h2>
                <p><strong>Company:</strong> ${content.company}</p>
                <p><strong>URL:</strong> <a href="${content.url}" target="_blank">${content.url}</a></p>
                <p><strong>Extracted:</strong> ${new Date(content.timestamp).toLocaleString()}</p>
                <p><strong>Content Length:</strong> ${content.contentLength} characters</p>
                <p><strong>Relevance Score:</strong> ${content.relevanceScore}/10</p>
                <p><strong>Keywords:</strong> ${content.keywords}</p>
                <hr style="margin: 20px 0; border-color: var(--border-color);">
                <h3>Full Content</h3>
                <pre style="white-space: pre-wrap; font-family: inherit; background: var(--primary-bg); padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">${content.fullContent}</pre>
                <button class="button button-primary" style="position: absolute; top: 20px; right: 20px;" onclick="this.parentElement.parentElement.remove()">✕ Close</button>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Resume paused baseline generation
        async function resumeBaselineGeneration(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            try {
                const result = await apiCall('baseline-resume');
                
                if (result.success) {
                    showSuccess('🔄 Baseline generation resumed!');
                    
                    // Restart polling
                    if (!baselinePollingInterval) {
                        baselinePollingInterval = setInterval(pollBaselineProgress, 2000);
                    }
                    pollBaselineProgress();
                } else {
                    showError('Failed to resume: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Error resuming baseline: ' + error.message);
            }
        }
        
        // Cancel baseline generation
        async function cancelBaselineGeneration(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            if (!confirm('Are you sure you want to cancel the baseline generation?')) {
                return;
            }
            
            try {
                const result = await apiCall('baseline-cancel');
                
                if (result.success) {
                    showSuccess('❌ Baseline generation cancelled');
                    
                    // Stop polling
                    if (baselinePollingInterval) {
                        clearInterval(baselinePollingInterval);
                        baselinePollingInterval = null;
                    }
                    
                    document.getElementById('baselineContent').innerHTML = '<div class="error-message">Baseline generation was cancelled.</div>';
                } else {
                    showError('Failed to cancel: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                showError('Error cancelling baseline: ' + error.message);
            }
        }

        async function loadChangeHistory(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            try {
                const data = await apiCall('changes');
                
                if (data.error) {
                    document.getElementById('changeHistoryContent').innerHTML = '<div class="error-message">No AI-analyzed change history available</div>';
                    return;
                }
                
                document.getElementById('changeHistoryContent').innerHTML = `
                    <div class="success-message">
                        🤖 AI-filtered change detection system is operational<br>
                        ${data.aiFiltered ? '✅ AI relevance filtering active' : '⚙️ Setting up AI filters'}<br>
                        📊 Ready to analyze changes with intelligent scoring
                    </div>
                `;
            } catch (error) {
                document.getElementById('changeHistoryContent').innerHTML = `<div class="error-message">❌ Error loading AI change history: ${error.message}</div>`;
            }
        }

        async function loadConfiguration(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            try {
                const data = await apiCall('config');
                
                if (data.error) {
                    document.getElementById('configurationContent').innerHTML = '<div class="error-message">No AI system configuration available</div>';
                    return;
                }
                
                document.getElementById('configurationContent').innerHTML = `
                    <div class="config-section">
                        <h4>📊 AI-Enhanced System Configuration</h4>
                        ${data.aiEnhanced ? '<div class="success-message">🤖 AI Intelligence Features: Active</div>' : ''}
                        <div class="success-message">✅ CORS Status: Fixed and operational</div>
                        <div class="success-message">🔧 Version: v84 - All scripts restored + TheBrain integration ready</div>
                        <pre style="background: var(--primary-bg); padding: 15px; border-radius: 8px; overflow-x: auto; color: var(--text-primary);">
${JSON.stringify(data, null, 2)}
                        </pre>
                    </div>
                `;
            } catch (error) {
                document.getElementById('configurationContent').innerHTML = `<div class="error-message">❌ Error loading AI configuration: ${error.message}</div>`;
            }
        }

        async function loadSystemLogs(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            try {
                const data = await apiCall('logs');
                
                if (data.error) {
                    document.getElementById('systemLogsContent').innerHTML = '<div class="error-message">Unable to load AI system logs</div>';
                    return;
                }
                
                if (data.logs && data.logs.length > 0) {
                    let html = '<div class="log-container">';
                    if (data.aiEnhanced) {
                        html += '<div style="color: var(--accent-color); margin-bottom: 10px;">🤖 AI-Enhanced System Logs</div>';
                    }
                    
                    data.logs.forEach(log => {
                        html += `
                            <div class="log-entry">
                                <div class="log-timestamp">${new Date(log.timestamp).toLocaleString()}</div>
                                <div class="log-level-${log.type || log.level || 'info'}">${log.message}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('systemLogsContent').innerHTML = html;
                } else {
                    document.getElementById('systemLogsContent').innerHTML = '<div class="success-message">🤖 AI-Enhanced System v80: All systems operational with extracted data fixes active</div>';
                }
            } catch (error) {
                document.getElementById('systemLogsContent').innerHTML = `<div class="error-message">❌ Error loading AI system logs: ${error.message}</div>`;
            }
        }

        // TheBrain Integration
        function openTheBrain(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            showSuccess('🧠 Opening TheBrain AI knowledge integration...');
            window.open('https://thebrain.com', '_blank');
        }

        // Configuration Management Functions
        function showAddCompanyForm(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            document.getElementById('addCompanyForm').style.display = 'block';
        }
        
        function hideAddCompanyForm(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            document.getElementById('addCompanyForm').style.display = 'none';
            // Clear form
            document.getElementById('newCompanyName').value = '';
            document.getElementById('newCompanyUrls').value = '';
            document.getElementById('newCompanyType').value = 'competitor';
        }
        
        async function addCompany(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            const name = document.getElementById('newCompanyName').value.trim();
            const urls = document.getElementById('newCompanyUrls').value.trim().split('\n').filter(u => u.trim());
            const type = document.getElementById('newCompanyType').value;
            
            if (!name) {
                showError('Please enter a company name');
                return;
            }
            
            if (urls.length === 0) {
                showError('Please enter at least one URL');
                return;
            }
            
            try {
                const result = await apiCall('add-company', {
                    company: name,
                    urls: urls.join(','),
                    type: type
                });
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                showSuccess(`✅ Company "${name}" added successfully!`);
                hideAddCompanyForm();
                loadCompanyList();
                
            } catch (error) {
                showError(`❌ Error adding company: ${error.message}`);
            }
        }
        
        async function loadCompanyList(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            document.getElementById('companyListContainer').innerHTML = '<div class="loading">Loading companies...</div>';
            
            try {
                const data = await apiCall('config');
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const companies = data.companies || data.monitors || [];
                
                let html = '<div class="companies-grid">';
                companies.forEach((company, index) => {
                    html += `
                        <div class="company-card">
                            <h3>${company.company}</h3>
                            <div class="status status-operational">${company.type || 'Competitor'}</div>
                            <p><strong>URLs:</strong> ${company.urls ? company.urls.length : 0}</p>
                            <div class="action-buttons" style="margin: 10px 0;">
                                <button class="button button-secondary" onclick="editCompany(${index})">✏️ Edit</button>
                                <button class="button button-warning" onclick="removeCompany('${company.company}')">🗑️ Remove</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                if (companies.length === 0) {
                    html = '<div class="error-message">No companies configured yet. Click "Add Company" to get started.</div>';
                }
                
                document.getElementById('companyListContainer').innerHTML = html;
                
            } catch (error) {
                document.getElementById('companyListContainer').innerHTML = `
                    <div class="error-message">❌ Error loading companies: ${error.message}</div>
                `;
            }
        }
        
        async function removeCompany(companyName) {
            if (!confirm(`Are you sure you want to remove "${companyName}" and all its data?`)) {
                return;
            }
            
            try {
                const result = await apiCall('remove-company', { company: companyName });
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                showSuccess(`✅ Company "${companyName}" removed successfully`);
                loadCompanyList();
                
            } catch (error) {
                showError(`❌ Error removing company: ${error.message}`);
            }
        }
        
        async function saveMonitoringParameters(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            const frequency = document.getElementById('checkFrequency').value;
            const changeThreshold = document.getElementById('changeThreshold').value;
            const relevanceThreshold = document.getElementById('relevanceThreshold').value;
            
            try {
                const result = await apiCall('update-parameters', {
                    frequency: frequency,
                    changeThreshold: changeThreshold,
                    relevanceThreshold: relevanceThreshold
                });
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                showSuccess('✅ Monitoring parameters saved successfully!');
                
            } catch (error) {
                showError(`❌ Error saving parameters: ${error.message}`);
            }
        }
        
        async function loadSystemConfig(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                addClickFeedback(event.target);
            }
            
            try {
                const data = await apiCall('config');
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                document.getElementById('systemConfigContent').innerHTML = `
                    <div class="success-message">
                        <h4>📊 Current System Configuration</h4>
                        <pre style="background: var(--primary-bg); padding: 15px; border-radius: 8px; overflow-x: auto;">
${JSON.stringify(data, null, 2)}
                        </pre>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('systemConfigContent').innerHTML = `
                    <div class="error-message">❌ Error loading config: ${error.message}</div>
                `;
            }
        }
        
        // Utility Functions
        function formatTimeAgo(date) {
            if (!date) return 'Never';
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            const intervals = [
                { label: 'year', seconds: 31536000 },
                { label: 'month', seconds: 2592000 },
                { label: 'week', seconds: 604800 },
                { label: 'day', seconds: 86400 },
                { label: 'hour', seconds: 3600 },
                { label: 'minute', seconds: 60 }
            ];
            
            for (const interval of intervals) {
                const count = Math.floor(seconds / interval.seconds);
                if (count > 0) {
                    return count === 1 ? `${count} ${interval.label} ago` : `${count} ${interval.label}s ago`;
                }
            }
            return 'just now';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorDisplay');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '1000';
            errorDiv.style.maxWidth = '400px';
            console.error('❌', message);
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            console.log('✅', message);
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>